name: Auto-Delete Feature Branches

on:
  pull_request:
    types: [closed]
    branches:
      - dev

jobs:
  delete-branch:
    name: Delete Merged Feature Branch
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'feature/')
    permissions:
      contents: write
    steps:
      - name: Delete feature branch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ—‘ï¸  PR #${{ github.event.pull_request.number }} was merged"
          echo "ğŸŒ¿ Deleting branch: ${{ github.head_ref }}"

          # Delete the branch using GitHub API
          gh api \
            --method DELETE \
            repos/${{ github.repository }}/git/refs/heads/${{ github.head_ref }} \
            && echo "âœ… Branch deleted successfully" \
            || echo "âš ï¸  Branch may already be deleted (repo setting: delete_branch_on_merge)"

      - name: Log branch cleanup
        run: |
          echo "Branch cleanup summary:"
          echo "  PR: #${{ github.event.pull_request.number }}"
          echo "  Branch: ${{ github.head_ref }}"
          echo "  Merged into: ${{ github.base_ref }}"
          echo "  Merged by: ${{ github.event.pull_request.merged_by.login }}"
